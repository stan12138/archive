## 树莓派视频串流

欧科，所以这里的目的基本就是借助树莓派实现实时视频监控。

至于工具的话，我知道有一些现成的工具，傻瓜式的操作那种，也许工作状况也更好，但是我不想要这种。所以，我的工具流是利用picamera模块捕捉画面，利用flask完成串流的传输，前两天我也买了一个极简版的云台骨架，所以我也会尝试在web端同时增加用户登录和舵机控制功能。

当然，我对串流技术几乎一无所知，这里我的参考资料和所有的代码都是在[这位作者]( https://blog.miguelgrinberg.com/post/video-streaming-with-flask )的博客和[github代码]( https://github.com/miguelgrinberg/flask-video-streaming )基础上修改的，在这里表达感谢。

其实至少一年半之前，甚至将近两年之前，我已经尝试过一次，但是当时我还是个智障(现在也差不多)，并不是非常理解，也没有能力做太多的好的修改，测试是成功的，但是我没留下几乎任何代码和文档，所以现在再试一次。反正现在也不想学习，心情也蛮糟糕的，那就干脆找点事情来做好了。

在第一部分我会尝试翻译picamera文档的部分内容，之后也会尝试说明一些硬件问题，以及GPIO舵机控制，之后说明Flask构建整个在线网站的基础架构。



### Picamera

如何安装库以及如何设置安装摄像头的硬件部分就不再描述了。

~~~python
from time import sleep
from picamera import PiCamera

camera = PiCamera()
camera.resolution = (1024, 768)
camera.start_preview()

sleep(2)  # 相机预热
camera.capture("foo.jpg")
~~~

此外可以把camera获取到的数据输送进入各种stream中， 如file object BytesIO， socket等等。



`camera.capture("foo.jpg", resize=(320, 240))`可以将获取到的内容resize，这个过程将在GPU执行， 因此高效得多。

获取连续内容

捕捉连续画面的时候， 需要注意很多事情， 例如曝光时间，白平衡，画面增益等等。

曝光时间： `shutter_speed`

`iso`

曝光增益： `analog_gain`和`digital_gain`， 设置`exposure_mode` to off

白平衡： `awb_mode` to off ， 设置`awb_gains`

这些数值的设置很难，对于`iso`，一般而言，白天是`100~200`，暗光下`400~800`， 可以查询`exposure_speed`来设置`shutter_speed`， 。。。。。看文档吧

一个上述设置的简单例子：

~~~python
from time import sleep
from picamera import PiCamera

camera = PiCamera(resolution=(1280, 720), framerate=30)
camera.iso = 100
sleep(2)

camera.shutter_speed = camera.exposure_speed
camera.exposure_mode = "off"
g = camera.awb_gains
camera.awb_mode = "off"
camera.awb_gains = g

camera.capture_sequence(["image%02d.jpg"%i for i in range(10)])
~~~



延时拍摄序列

`capture_continuous()`， 此时相机会持续获取画面，直至让他停止。图片会自动赋予名字，可以方便的控制画面之间的间隔。

~~~python
import time
import picamera

with picamera.PiCamera() as camera:
    camera.start_preview()
    time.sleep(2)
    for filename in camera.capture_continuous('img{counter:03d}.jpg'):
        print('Captured %s' % filename)
        time.sleep(300)
~~~

也可以在特定时间自动拍照，参见文档



低光拍摄要设置高增益和长曝光



输出至网络串流

这里文档上给出了一个使用自定义极简协议的socket串流



视频录制

到文件

到流

到多部份文件

到环形缓冲流

到网络串流，这里给出了一个基于socket的视频串流代码，但是和之前文件一样不是基于HTTP协议的，只是简单地把数据发送过来到播放器而已

另外支持叠加功能，支持在获取的内容上面覆盖图片或者文字。

可以控制相机上的LED的开关



这里记录一下我买的相机的参数，商品已经被下架了，得记录一下：

![image-20191126215831642](images/image-20191126215831642.png)

网上说500万像素的话，分辨率是2560*1920